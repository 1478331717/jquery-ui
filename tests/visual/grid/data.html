<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Grid: Data</title>
	<link rel="stylesheet" href="../../../themes/base/jquery.ui.all.css">
	<script src="../../../jquery-1.4.4.js"></script>
	<script src="../../../external/jquery.tmpl.js"></script>
	<script src="../../../ui/jquery.ui.core.js"></script>
	<script src="../../../ui/jquery.ui.widget.js"></script>
	<script>
	$.widget( "ui.datastore", {
		_create: function() {
			this.items = {};
		},
		create: function( type, props ) {
			return $.ui.datasource.types[ type ].create( props );
		},
		_normalize: function( type, id ) {
			var item = this.items[ type ][ id ],
				ctor = $.ui.dataitem.types[ type ];
			if ( !( item instanceof $.ui.dataitem ) ) {
				item = this.items[ type ][ id ] = ctor({ data: item });
			}
			return item;
		},
		get: function( type, id ) {
			if ( id ) {
				return this._normalize( type, id );
			}

			for ( id in this.items[ type ] ) {
				this._normalize( type, id );
			}
			return $.ui.dataitems({ items: this.items[ type ] });
		},
		populate: function( type ) {
			$.ui.datasource.types[ type ].get( this );
		},
		_populate: function( type, items ) {
			var local = this.items[ type ];
			$.each( items, function( i, item ) {
				local[ item.guid ] = item;
			});
		},
		save: function() {
			$.each( this.items, function( type, items ) {
				$.ui.datasource.types[ type ].save( items );
			});
		}
	});
	$.ui.datastore.main = $.ui.datastore();

	$.widget( "ui.datasource", {
		options: {
			type: null,
			source: null
		},
		_create: function() {
			$.ui.datasource.types[ this.options.type ] = this;
			$.ui.datastore.main.items[ this.options.type ] = {};
		},
		create: function( props ) {
			this.options.source.push( props );
		},
		get: function( store ) {
			store._populate( this.options.type, this.options.source );
		},
		save: function( items ) {
			$.each( items, function( itemId, item ) {
				item.save();
			});
		},
	});
	$.ui.datasource.types = {};

	$.widget( "ui.dataitem", {
		options: {
			data: null
		},
		_create: function() {
		},
		get: function( key ) {
			return this.options.data[ key ];
		},
		set: function( key, vaule ) {
			this.options.data[ key ] = value;
			return this;
		}
	});
	$.ui.dataitem.types = {};
	$.ui.dataitem.extend = function( type, prototype ) {
		$.widget( "ui.dataitem-" + type, $.ui.dataitem, prototype );
		$.ui.dataitem.types[ type ] = $.ui[ "dataitem-" + type ];
	};

	$.widget( "ui.dataitems", {
		options: {
			items: null
		}
	});

	$.widget( "ui.grid", {
		options: {
			type: null,
			rowTemplate: null
		},
		_create: function() {
			if ( !this.options.type ) {
				this._parseData();
			}
			var that = this;
			this.element.addClass( "ui-widget" );
			this.element.find( "th" ).addClass( "ui-widget-header" );
			this.element.delegate( "tbody > tr", "click", function( event ) {
				that._trigger( "select", event, {
					item: $.ui.datastore.main.get( that.options.type,
						$( this ).tmplItem().data.guid )
				});
			});
			this.refresh();
		},
		refresh: function() {
			var tbody = this.element.find( "tbody" ).empty(),
				items = $.ui.datastore.main.get( this.options.type ).options.items,
				template = this.options.rowTemplate;
			$.each( items, function( itemId, item ) {
				$.tmpl( template, item.options.data ).appendTo( tbody );
			});
			tbody.find( "td" ).addClass( "ui-widget-content" );
		},
		_parseData: function() {
			var type = "generated" + $.now();
			this.options.type = type;

			var fields = this.element.find( "th" ).map(function() {
				return $( this ).data( "field" );
			}).get();

			var items = this.element.find( "tbody" ).children().map(function() {
				var item = { guid: $( this ).data( "guid" ) };
				$( this ).children().each(function( i ) {
					item[ fields[ i ] ] = $( this ).text();
				});
				return item;
			}).get();

			var template = $.map( fields, function( field ) {
				return "<td>${" + field + "}</td>";
			}).join( "" );
			template = "<tr>" + template + "</tr>";
			this.options.rowTemplate = template;

			$.ui.datasource({
				type: type,
				source: items
			});
			$.ui.dataitem.extend( type, {} );
			$.ui.datastore.main.populate( type );
		}
	});

	//----------------------------------------
	// Application level
	//----------------------------------------

	$.ui.dataitem.extend( "developer", {
		fullName: function() {
			return this.get( "firstName" ) + " " + this.get( "lastName" );
		}
	});

	var data = [
		{
			guid: 1,
			firstName: "Scott",
			lastName: "González",
			country: "USA",
			twitter: "scott_gonzalez",
			github: "scottgonzalez"
		},
		{
			guid: 2,
			firstName: "Richard",
			lastName: "Worth",
			country: "USA",
			twitter: "rworth",
			github: "rdworth"
		},
		{
			guid: 3,
			firstName: "Jörn",
			lastName: "Zaefferer",
			country: "Germany",
			twitter: "bassistance",
			github: "jzaefferer"
		}
	];

	$.ui.datasource({
		type: "developer",
		source: data
	});
	$.ui.datastore.main.populate( "developer" );

	$(function() {
		$( "#developers" ).grid({
			type: "developer",
			rowTemplate: $( "#row-tmpl" ).html(),
			select: showDetails
		});

		$( "#developers-pe" ).grid({
			select: showDetails
		});

		function showDetails( event, ui ) {
			$( "#developer-tmpl" )
				.tmpl( ui.item.options.data )
				.appendTo( $( "#developer" ).empty() );
		}
	});
	</script>
</head>
<body>

<h2>data extraction</h2>
<table id="developers-pe">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
			<th data-field="twitter">Twitter</th>
			<th data-field="github">GitHub</th>
		</tr>
	</thead>
	<tbody>
		<tr data-guid="john.resig">
			<td>John</td>
			<td>Resig</td>
			<td>USA</td>
			<td>jeresig</td>
			<td>jeresig</td>
		</tr>
		<tr data-guid="scott.jehl">
			<td>Scott</td>
			<td>Jehl</td>
			<td>USA</td>
			<td>filamentgroup</td>
			<td>scottjehl</td>
		</tr>
	</tbody>
</table>

<h2>data source</h2>
<table id="developers">
	<thead>
		<tr>
			<th data-field="firstName">First Name</th>
			<th data-field="lastName">Last Name</th>
			<th data-field="country">Country</th>
		</tr>
	</thead>
	<tbody>
	</tbody>
</table>

<div id="developer"></div>

<script type="text/x-jquery-tmpl" id="row-tmpl">
<tr>
	<td>${firstName}</td>
	<td>${lastName}</td>
	<td>${country}</td>
</tr>
</script>

<script type="text/x-jquery-tmpl" id="developer-tmpl">
<div>
	<h2>${lastName}, ${firstName}</h2>
	<p>GitHub: <a href="http://github.com/${github}">${github}</a></p>
	<p>Twitter: <a href="http://twitter.com/${twitter}">${twitter}</a></p>
</div>
</script>

</body>
</html>
